---
title: "ã‚‚ã—ã‚ãªãŸãŒ1äººã£ãã‚Šã§SaaSã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ä½œã‚‹ã“ã¨ã«ãªã£ãŸã‚‰..."
emoji: "ğŸ«µ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "Terraform"]
published: true
published_at: "2023-12-07"
---

ã“ã®è¨˜äº‹ã¯ã€[ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ Advent Calendar 2023](https://qiita.com/advent-calendar/2023/crowdworks) ã‚·ãƒªãƒ¼ã‚º1ã®7æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

# ã¯ã˜ã‚ã«

crowdworks.jpã§SREã‚’ã—ã¦ã„ã¾ã™ciloholicã§ã™ã€‚

å‰è·ã§ã¯ã€é•·ã‚‰ããƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å…¼ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ãŸã‚“ã§ã™ãŒã€ã‚ã‚‹æ—¥çªç„¶SaaSã‚’ä½œã‚‹ãã¨è¨€ã‚ã‚Œã¦ã€SaaSã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’1äººã§ä½œã‚‹ç¾½ç›®ã«ãªã£ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
å½“æ™‚ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹è‡ªä½“ã®é–‹ç™ºã«è¿½ã‚ã‚Œã¦ã„ã¦ã€AWSã®ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã®å°å…¥(Config/CloudTrail/GuardDutyç­‰)ãªã©ãŒãŠã–ãªã‚Šã«ãªã£ã¦ã„ã¾ã—ãŸã€‚
ãã®æ™‚ã®æˆ’ã‚ã‚’è¾¼ã‚ã¦ã€å†ã³ã€ŒSaaSã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ä½œã‚Œã€ã¨è¨€ã‚ã‚Œã¦ã‚‚å¤§ä¸ˆå¤«ãªã‚ˆã†ã«ã€Terraformã§AWSã®ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã®å°å…¥ã‚’è¡Œãªã£ã¦ã¿ã¾ã—ãŸã€‚

ã‚¿ã‚¤ãƒˆãƒ«ã§ã¯ **SaaSã®ã‚¤ãƒ³ãƒ•ãƒ©** ã¨ã„ã†ã‚ˆã†ã«è©±é¡Œã‚’å¤§ãã‚ã«æ›¸ã„ã¦ã¾ã™ãŒã€æœ¬è¨˜äº‹ã§ã¯ **AWSã®ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†** ã¨ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã®å°å…¥** ã®ã¿ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚
ãã‚Œä»¥å¤–ã«ã¤ã„ã¦ã¯ã€SaaSã«ã‚ˆã£ã¦åƒå·®ä¸‡åˆ¥ãªã®ã§ã€æœ¬è¨˜äº‹ã§ã¯å‰²æ„›ã—ã¦ã„ã¾ã™ã€‚

å®Ÿéš›ã«Terraformã§å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã¯ã€[GitHub](https://github.com/ciloholic/multi_aws_account)ã«æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ã€Terraformã®ã‚³ãƒ¼ãƒ‰ã¯è¼‰ã›ãšã€å®Ÿè£…ã®æµã‚Œã‚„å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹ãªã©ã‚’ä¸»ã«æ›¸ãé€£ã­ã¦ã„ãã¾ã™ã€‚

# æƒ³å®šã—ã¦ã„ã‚‹AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ§‹æˆ

AWSã§ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã‚’è¡ŒãªãŠã†ã¨ã—ãŸå ´åˆã€[AWS Organizations](https://aws.amazon.com/jp/organizations/)ã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚
AWS Organizationsã§ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ãªæ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

> AWS Organizations ã«ã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã‚’ä¸€å…ƒç®¡ç†ãŠã‚ˆã³çµ±åˆ¶ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ 1 ã¤ã®è«‹æ±‚æ›¸ã§ç®¡ç†ãŠã‚ˆã³æ•´ç†ã—ãŸã‚Šã€çµ„ç¹”å…¨ä½“ã®ä¸­å¤®ãƒãƒªã‚·ãƒ¼ã¨è¨­å®šè¦ä»¶ã‚’è¨­å®šã—ãŸã‚Šã€çµ„ç¹”å†…ã«ã‚«ã‚¹ã‚¿ãƒ ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã¾ãŸã¯æ©Ÿèƒ½ã‚’ä½œæˆã—ãŸã‚Šã€ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«è²¬ä»»ã‚’å§”ä»»ã—ã¦çµ„ç¹”ã®ä»£ã‚ã‚Šã«ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
> åŠ ãˆã¦ã€AWS Organizations ã¯ä»–ã® AWS ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨çµ±åˆã—ã¦ã„ã‚‹ãŸã‚ã€ä¸­å¤®ã§ã®è¨­å®šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã€ç›£æŸ»è¦ä»¶ã€çµ„ç¹”å†…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé–“ã§ã®ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰ã‚’å®šç¾©ã§ãã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã‚‚ä¾‹ã«æ¼ã‚Œãšã€AWS Organizationsã‚’åˆ©ç”¨ã—ã¦ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã‚’è¡Œãªã£ã¦ã„ãã¾ã™ã€‚

ä¾¿åˆ©ãªã‚‚ã®ã§ã€å®‰å…¨ãªãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆAWSç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ç®¡ç†ã§ãã‚‹[AWS Control Tower](https://aws.amazon.com/jp/controltower/)ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€AWS Organizationsã®è¨­å®šã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã®å°å…¥ã‚’è‡ªå‹•ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã‚Œã¾ã™ã€‚
ã—ã‹ã—ã€è‡ªä¸»ç·´ã«ãªã‚‰ãªã„ãŸã‚ã€[AWS Control Towerã®æ§‹æˆ](https://docs.aws.amazon.com/whitepapers/latest/organizing-your-aws-environment/production-starter-organization.html)ã‚’å‚è€ƒã«OUæ§‹æˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦è‡ªä½œã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

å°è¦æ¨¡ãªSaaSã§ã‚ã£ãŸã¨ã—ã¦ã‚‚ã€æœ¬ç•ªãƒ»é–‹ç™ºãƒ»ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãã‚‰ã„ã¯AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ†ã‘ãŸã„ã¨ã“ã‚ã§ã™ã€‚
ã¾ãŸã€ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ç’°å¢ƒã«åŠ ãˆã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç”¨ã‚„ãƒ­ã‚°é›†ç©ç”¨ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚‚æ¬²ã—ã„ã§ã™ã€‚
æœ¬æ¥ãªã‚‰ã€Log-Archiveç”¨ã‚„Auditç”¨ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚‚ä½œæˆã—ãŸã„ã¨ã“ã‚ã§ã™ãŒã€è‡ªä¸»ç·´ã®ãŸã‚ã«ä½•å€‹ã‚‚AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ãŸããªã„ã®ã§ã€Securityç”¨ã«çµ±åˆã—ã¦ã„ã¾ã™ã€‚

- Root
  - [Account]Management
  - [OU]Core
    - [Account]Jump
    - [Account]Security( + Log-Archive + Audit)
  - [OU]Workloads
    - [Account]Production
    - [Account]Development
    - [Account]Staging

# Terraformå‘¨ã‚Šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

Terraformå‘¨ã‚Šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯ã€ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

- Terraform: v1.6.4
- terraform-provider-aws: v5.26.0

# Terraformã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

Terraformã§å®Ÿè£…ã™ã‚‹éš›ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã«ã—ã¦ã„ã¾ã™ã€‚
å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ã«tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã¦ç®¡ç†ã—ã¾ã™ã€‚

```bash
.
â””â”€â”€ accounts
    â”œâ”€â”€ management
    â”‚   â””â”€â”€ .terraform-version
    â”œâ”€â”€ core
    â”‚   â”œâ”€â”€ jump
    â”‚   â”‚   â””â”€â”€ .terraform-version
    â”‚   â””â”€â”€ security
    â”‚       â””â”€â”€ .terraform-version
    â””â”€â”€ workloads
        â”œâ”€â”€ production
        â”‚   â””â”€â”€ .terraform-version
        â”œâ”€â”€ development
        â”‚   â””â”€â”€ .terraform-version
        â””â”€â”€ staging
            â””â”€â”€ .terraform-version
```

# AWSã®ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†

## AWS Organizations

åˆã‚ã«Organizationã¨OUã€å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

### Organizationã¨OUã®ä½œæˆ

- [accounts/management/organization.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/organization.tf)
  - aws_organizations_organization.org
  - aws_organizations_organizational_unit.core
  - aws_organizations_organizational_unit.workloads

### å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ

AWS Organizationsã§AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã¨ã€ãƒ«ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åŠ ãˆã¦ **OrganizationAccountAccessRole** ã¨ã„ã†IAMãƒ­ãƒ¼ãƒ«ãŒè‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™ã€‚
ä»Šå¾Œã¯ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè£…ã™ã‚‹ã¾ã§ã€ã“ã®IAMãƒ­ãƒ¼ãƒ«ã«ã‚¹ã‚¤ãƒƒãƒã—ã¦AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

- [accounts/management/organization.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/organization.tf)
  - aws_organizations_account.jump
  - aws_organizations_account.security
  - aws_organizations_account.[production/development/staging]

#### [å°ãƒã‚¿]AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤

[terraform-provider-aws v4.9.0](https://github.com/hashicorp/terraform-provider-aws/releases/tag/v4.9.0)ã§ã¯ã€`aws_organizations_account`ã«`close_on_deletion`ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚
`close_on_deletion`ã‚’`true`ã«ã™ã‚‹ã¨ã€AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒé–‰é–ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ä»¥å‰ã¯ã€Oraganizationã‹ã‚‰AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒé™¤å¤–ã•ã‚Œã‚‹ã ã‘ã§ã€AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é–‰é–ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
ã¡ã‚ƒã‚“ã¨é–‰é–ã—ãŸã„å ´åˆã¯ã€`close_on_deletion`ã‚’`true`ã«ã—ã¦ãŠãã¨è‰¯ã„ã§ã™ã€‚
AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆé–‰é–å¾Œã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ããªããªã‚Šã€90æ—¥çµŒéã™ã‚‹ã¨å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

### å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå¾Œã®å¯¾å¿œ

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ç‚ºã€å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®MFAæœ‰åŠ¹åŒ–ã ã‘ã¯å¿…é ˆã§å¯¾å¿œã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

- [**å¿…é ˆ**]ãƒ«ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®MFAæœ‰åŠ¹åŒ–
  - åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç™ºè¡Œã•ã‚Œã¦ãªã„ãŸã‚ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰MFAã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
- [ä»»æ„]ä¸è¦ãªãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤
  - ä¸‹è¨˜URLã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‚è€ƒã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆVPCã€ã‚µãƒ–ãƒãƒƒãƒˆã€IGWã‚’å‰Šé™¤ã—ã¾ã™
  - https://dev.classmethod.jp/articles/delete-default-vpcs-by-cloudshell

### Service Control Policy(SCP)ã®ä½œæˆ

Service Control Policy(SCP)ã§ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å˜ä½ã®AWSã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ã¦ã„ã¾ã™ã€‚
åŸºæœ¬çš„ã« **ap-northeast-1** ã¨ **us-east-1** ã—ã‹åˆ©ç”¨ã—ãªã„æƒ³å®šã§ã™ãŒã€AWS ChatbotãŒ **us-east-2** ã§å‹•ä½œã—ã¦ã„ã‚‹ãŸã‚ã€**us-east-2** ã‚‚åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
AWS Chatbotã®ã‚ˆã†ãªä¾‹ã‚‚ã‚ã‚‹ã®ã§ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å˜ä½ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã«ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

- [accounts/management/organization.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/organization.tf)
  - aws_organizations_policy.region_restriction
  - aws_organizations_policy.core_region_restriction
  - aws_organizations_policy.workloads_region_restriction
  - aws_organizations_policy_attachment.core_region_restriction
  - aws_organizations_policy_attachment.workloads_region_restriction

#### [å°ãƒã‚¿]AWS Chatbotã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³

AWS Chatbotã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚
https://docs.aws.amazon.com/chatbot/latest/adminguide/chatbot-troubleshooting.html#chatbot-troubleshooting-regions

## tfstateç”¨S3ãƒã‚±ãƒƒãƒˆã®ä½œæˆ

å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®S3ã«tfstateç”¨ã®S3ãƒã‚±ãƒƒãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚
S3ãƒã‚±ãƒƒãƒˆåã®æœ«å°¾ã«ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ã‚’ä»˜ä¸ã—ã¦é‡è¤‡ã—ãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
å¿…è¦ã§ã‚ã‚Œã°ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚‚æœ‰åŠ¹ã«ã—ã¦ãŠãã¾ã™ã€‚

```bash:tfstateç”¨S3ãƒã‚±ãƒƒãƒˆ
$ aws-vault exec *** -- aws s3api create-bucket \
  --bucket tfstate-me8aelie \
  --region ap-northeast-1 \
  --create-bucket-configuration \
  LocationConstraint=ap-northeast-1
```

S3ãƒã‚±ãƒƒãƒˆãŒä½œæˆã§ããŸã‚‰ã€Terraformã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãŠãã¾ã™ã€‚

ã“ã®ä½œæ¥­ã‚’å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚‚åŒæ§˜ã«è¡Œãªã„ã¾ã™ã€‚

- [accounts/management/s3.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/s3.tf)
  - aws_s3_bucket.tfstate_me8aelie
  - aws_s3_bucket_ownership_controls.tfstate_me8aelie
  - aws_s3_bucket_server_side_encryption_configuration.tfstate_me8aelie

## IAMã®ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã®è¨­å®š

å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—ã¦ã€IAMã®ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã‚’è¨­å®šã‚’è¡Œãªã„ã¾ã™ã€‚

### Jumpã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

ç®¡ç†è€…æ¨©é™ä»˜ãã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç”¨æ„ã—ã¾ã™ã€‚
å¿…è¦ã§ã‚ã‚Œã°ã€è‡ªèº«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ¨©é™ã‚„MFAå¤‰æ›´æ¨©é™ã‚’ä»˜ä¸ã—ãŸä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ä½œæˆã—ã¦ã¿ã¦ãã ã•ã„ã€‚

- [accounts/core/jump/iam_user.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/core/jump/iam_user.tf)
  - aws_iam_user.tarou_yamada
  - aws_iam_user_group_membership.tarou_yamada

### Jumpã‚¢ã‚«ã‚¦ãƒ³ãƒˆä»¥å¤–

Jumpã‚¢ã‚«ã‚¦ãƒ³ãƒˆçµŒç”±ã®MFAæœ‰åŠ¹æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã€ç®¡ç†è€…æ¨©é™ä»˜ãã®IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
å¿…è¦ã§ã‚ã‚Œã°ã€æ¨©é™ã‚’åˆ¶é™ã—ãŸä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®IAMãƒ­ãƒ¼ãƒ«ã‚‚ä½œæˆã—ã¦ã¿ã¦ãã ã•ã„ã€‚

ã“ã®ä½œæ¥­ã‚’å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚‚åŒæ§˜ã«è¡Œãªã„ã¾ã™ã€‚

- [accounts/management/iam.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/iam.tf)
  - aws_iam_role.management_admin

### ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã®å‹•ä½œç¢ºèª

ã“ã“ã¾ã§ã§ãã¦ã„ã‚Œã°ã€å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

---

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã®å°å…¥

## Auditç”¨S3ãƒã‚±ãƒƒãƒˆã®ä½œæˆ

Securityã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«AWS Configã¨AWS CloudTrailã®ãƒ­ã‚°ã‚’æ ¼ç´ã™ã‚‹S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®AWS Configã¨AWS CloudTrailã®ãƒ­ã‚°ã¯ã€ã“ã®S3ãƒã‚±ãƒƒãƒˆã«é›†ç´„ã•ã‚Œã¾ã™ã€‚

- [accounts/core/security/s3.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/core/security/s3.tf)
  - aws_s3_bucket.aws_config
  - aws_s3_bucket_server_side_encryption_configuration.aws_config
  - aws_s3_bucket_policy.aws_config
  - aws_s3_bucket.aws_cloudtrail
  - aws_s3_bucket_server_side_encryption_configuration.aws_cloudtrail
  - aws_s3_bucket_policy.aws_cloudtrail

## AWS Config

å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«AWS Configã‚’å°å…¥ã—ã¾ã™ã€‚

AWS Configã¯ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å˜ä½ã«æœ‰åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€åˆ©ç”¨å¯èƒ½ãªã™ã¹ã¦ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§æœ‰åŠ¹åŒ–ã™ã‚‹ã®ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ã€AWS Organizationsã®SCPã§ä¸è¦ãªãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’ã—ã¦ã„ã‚‹ã®ã§ã€åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã ã‘ã§æ¸ˆã¾ã›ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€`aws_config_configuration_recorder`ã§ä½œæˆã™ã‚‹ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒªã‚½ãƒ¼ã‚¹ã®è¨˜éŒ²ã‚‚å«ã¾ã‚Œã¦ã—ã¾ã†ãŸã‚ã€æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒªã‚½ãƒ¼ã‚¹ã‚’è¨˜éŒ²ã—ã€ä»–ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯è¨˜éŒ²ã—ãªã„ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

ã“ã®ä½œæ¥­ã‚’å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚‚åŒæ§˜ã«è¡Œãªã„ã¾ã™ã€‚

- [accounts/management/config.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/config.tf)
  - aws_config_configuration_recorder.config_recorder
  - aws_config_delivery_channel.default
  - aws_config_configuration_recorder_status.default
  - aws_config_configuration_recorder.config_recorder_us_east_1
  - aws_config_delivery_channel.default_us_east_1
  - aws_config_configuration_recorder_status.default_us_east_1

### AWS Configã®å§”ä»»

AWS Configã¯ã€Securityã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å§”ä»»ã§ãã¾ã™ã€‚

ãŸã ã—ã€AWS Configã®å§”ä»»ã¯ã€TerraformçµŒç”±ã§ã¯è¡Œãªãˆãªã„ãŸã‚ã€AWS CLIã§å¯¾å¿œã—ã¾ã™ã€‚

```bash
$ aws-vault exec management -- aws organizations register-delegated-administrator --account-id 222222222222 --service-principal config.amazonaws.com
$ aws-vault exec management -- aws organizations register-delegated-administrator --account-id 222222222222 --service-principal config-multiaccountsetup.amazonaws.com
```

### AWS Config Aggregator

ä¸Šè¨˜ã§AWS Configã®å§”ä»»ãŒå®Œäº†ã—ãŸã‚‰ã€Aggregatorã‚’å°å…¥ã—ã¾ã™ã€‚

AWS Config Aggregatorã¨ã„ã†æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€AWS Configã§åé›†ã—ã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚„AWS Config Ruleã®ãƒã‚§ãƒƒã‚¯çµæœã‚’ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆ/ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚ˆã‚Šé›†ç´„ã—ã¦ãƒ¬ãƒãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ãã¾ã™ã€‚
Aggregatorã‚’Securityã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å§”ä»»ã™ã‚‹ã“ã¨ã§ã€Securityã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰AWS Configã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

- [accounts/core/security/config.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/core/security/config.tf)
  - aws_config_configuration_aggregator.config_aggregator

## AWS CloudTrail

å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«AWS CloudTrailã‚’å°å…¥ã—ã¾ã™ã€‚

AWS CloudTrailã¯ã€Organizationã«ç´ã¥ããƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—ã¦ã€ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚ˆã‚Šãƒ­ã‚°ã‚’é›†ç´„ã§ãã¾ã™ã€‚
`is_organization_trail`ã‚’`true`ã«ã™ã‚Œã°ã€å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§AWS CloudTrailãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚

- [accounts/management/cloudtrail.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/cloudtrail.tf)
  - aws_cloudtrail.cloudtrail

### AWS CloudTrailã®å§”ä»»

AWS CloudTrailã¯ã€Securityã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å§”ä»»ã§ãã¾ã™ã€‚

ãŸã ã—ã€AWS CloudTrailã®å§”ä»»ã¯ã€TerraformçµŒç”±ã§ã¯è¡Œãªãˆãªã„ãŸã‚ã€AWS CLIã§å¯¾å¿œã—ã¾ã™ã€‚

```bash
$ aws-vault exec management -- aws organizations register-delegated-administrator --account-id 222222222222 --service-principal cloudtrail.amazonaws.com
```

## AWS GuardDuty

å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«AWS GuardDutyã‚’å°å…¥ã—ã¾ã™ã€‚

AWS GuardDutyã¯ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å˜ä½ã«æœ‰åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€åˆ©ç”¨å¯èƒ½ãªã™ã¹ã¦ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§æœ‰åŠ¹åŒ–ã™ã‚‹ã®ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ä½œæ¥­ã‚’å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚‚åŒæ§˜ã«è¡Œãªã„ã¾ã™ã€‚

- [accounts/management/guardduty.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/guardduty.tf)
  - aws_guardduty_detector.guardduty_detector
  - aws_guardduty_detector.guardduty_detector_us_east_1

### AWS GuardDutyã®å§”ä»»

AWS GuardDutyã¯ã€Securityã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å§”ä»»ã§ãã¾ã™ã€‚

- [accounts/management/guardduty.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/guardduty.tf)
  - aws_guardduty_organization_admin_account.guardduty

## AWS Security Hub

å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«AWS Security Hubã‚’å°å…¥ã—ã¾ã™ã€‚

AWS Security Hubã¯ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å˜ä½ã«æœ‰åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€åˆ©ç”¨å¯èƒ½ãªã™ã¹ã¦ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§æœ‰åŠ¹åŒ–ã™ã‚‹ã®ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®é©ç”¨ã¾ã§è¡Œãªã£ã¦ã„ãªã„ã®ã§ã€å¿…è¦ãªæ–¹ã¯åˆ¥é€”å¯¾å¿œã‚’ã—ã¦ãã ã•ã„ã€‚

ã“ã®ä½œæ¥­ã‚’å„ç¨®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚‚åŒæ§˜ã«è¡Œãªã„ã¾ã™ã€‚

- [accounts/management/securityhub.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/securityhub.tf)
  - aws_securityhub_account.securityhub
  - aws_securityhub_organization_admin_account.securityhub_us_east_1

### AWS Security Hubã®å§”ä»»

AWS Security Hubã¯ã€Securityã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å§”ä»»ã§ãã¾ã™ã€‚

- [accounts/management/securityhub.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/management/securityhub.tf)
  - aws_securityhub_organization_admin_account.securityhub

### AWS Security Hubã®æœ‰åŠ¹åŒ–

Organizationã«ç´ã¥ããƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—ã¦ã€AWS Security Hubã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚

ãŸã ã—ã€ãƒ¡ãƒ³ãƒãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®Security Hubæœ‰åŠ¹åŒ–ã¯ã€TerraformçµŒç”±ã§ã¯è¡Œãªãˆãªã„ãŸã‚ã€AWS CLIã§å¯¾å¿œã—ã¾ã™ã€‚

```bash
$ aws-vault exec security -- aws securityhub create-members --account-details '[{"AccountId":"<accountId>"}]'
```

### AWS Security Hub Finding Aggregator

ä¸Šè¨˜ã§AWS Security Hubã®å§”ä»»ãŒå®Œäº†ã—ãŸã‚‰ã€Finding Aggregatorã‚’å°å…¥ã—ã¾ã™ã€‚

AWS Security Hub Finding Aggregatorã¨ã„ã†æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€AWS Security Hubã§åé›†ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢ã‚’ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆ/ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚ˆã‚Šé›†ç´„ã§ãã¾ã™ã€‚
Finding Aggregatorã‚’Securityã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å§”ä»»ã™ã‚‹ã“ã¨ã§ã€Securityã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰AWS Security Hubã®ã‚¤ãƒ™ãƒ³ãƒˆçµæœã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

- [accounts/core/security/securityhub.tf](https://github.com/ciloholic/multi_aws_account/blob/main/accounts/core/security/securityhub.tf)
  - aws_securityhub_finding_aggregator.finding_aggregator

### AWS Security Hubã®é€šçŸ¥

AWS Security Hubã¯ã€ä»–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã¨çµ±åˆã™ã‚‹ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®é€šçŸ¥ã‚’ä¸€å…ƒç®¡ç†ã§ãã¾ã™ã€‚
æœ¬è¨˜äº‹ã§è¨€ã†ã¨ã€AWS Configã‚„AWS GuardDutyã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’AWS Security Hubã«é›†ç´„ã—ã€AWS EventBridgeã§æ¤œçŸ¥ã—ã¦AWS Chatbotã§Slackã«é€šçŸ¥ã§ãã¾ã™ã€‚

æœ¬æ¥ãªã‚‰é€šçŸ¥ã¾ã§å®Ÿè£…ã—ãŸã‹ã£ãŸã‚“ã§ã™ãŒã€AWS Security Hubã®å°å…¥ã¾ã§ã§åŠ›å°½ãã¾ã—ãŸã€‚

# ã•ã„ã”ã«

ä»Šå›ã¯ã€AWSã®ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã®å°å…¥ã‚’é›‘ã«Terraformã§å®Ÿè£…ã—ã¾ã—ãŸã€‚
å§”ä»»å‘¨ã‚Šã®å¯¾å¿œãŒTerraformã§ã§ããªã‹ã£ãŸã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã®å°å…¥ã«å››è‹¦å…«è‹¦ã™ã‚‹éƒ¨åˆ†ã‚‚ã‚ã‚Šã¾ã—ãŸãŒã€è‰¯ã„è‡ªä¸»ç·´ã«ãªã‚Šã¾ã—ãŸã€‚
ã“ã‚Œã§ã€çªç„¶SaaSã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ä½œã‚Œã¨è¨€ã‚ã‚Œã¦ã‚‚å¤§ä¸ˆå¤«ãã†ã§ã™ã€‚
